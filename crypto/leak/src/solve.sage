from Crypto.Cipher import AES
from Crypto.Util.Padding import pad, unpad
from ecdsa import SECP256k1
from ecdsa.ecdsa import Public_key, Private_key
import hashlib
import random

g = SECP256k1.generator
order = int(SECP256k1.order)

arr = [(32601052705578036603589466193154835875934882985604431182998236376667069266319, 5600481630340723583665203860989316829421814848301373, 7280399901983952414129988130268686570341935144922701220192716020182201247398, 26390023652430193225247254355615567061350346856342060966630533401481104625556), (49979602602318353310158186053208429459946480119422806384193351102608703440300, 3941563870946196529794421423767327976523484650325321, 46495207074977997170972954661936790749848474554616366439204095444976618560466, 112674711830454634962651362688184725849154552408360515326953589773383762555207), (9987051476813994796411876969442278462739331545277532043412653864012357441608, 23815034206606820027910705664346191902064116762059104, 2581778961905870585275574515647385537461010134028261384788041979721082139187, 45350272538266095121483567397556440522102163608128159704148592335843700726015), (72597125759078986730834387795099722026285389796035103924014909863081535942476, 56601316021548710619555578111227983194853059666269224, 21455834000330709456643942898278264606329385215499386849504179434863932560156, 109438555365342679677416323913248612725347521130103105466240229574474876991125), (46600705681289935934296527285147290165201411652122170475527231399104569240193, 77475459732018137133264872814269444922463721799733283, 98025129492592077293211015287974515520001970318386687535795001733811614738525, 98032784313418696505192106834166041529721296178029905487907402201792698800065), (110546410437011586226793018506443710638791741333314199289115846378567221637464, 7201030914297718052406739846876225831223875509772043, 44170093771318493003426124742096908644840046765848174330740011477264052351556, 109125968616019038717489097801514515599789583166107299476926516866617059926902), (44285151505189575792862258937225624144339825767522261091405361666996067556313, 15885096415729568180027092192787866813620120478827855, 48756358190427965514121490389813658370789743588267613289302989946761089726483, 85270564934588596263257382328782374994557031300391586349950881832750636728304), (20079499897948538743614618335175499883448084197420094815818355962319190755343, 11003858531865107534255886857900094481414843023769192, 30967763659335344130732110135582145809865498631678584690561522836337096993261, 108454276692188433109639585616571360455913365453610917723183070210367905928363), (95562440937919741303890770901161730959460829567012881428976302377789854057844, 18559712864955510616243900663109898670452819938378616, 13814861280383614761026853306130358517029385150422615942692965833599488559251, 76757168987350494937653677133033206418020211434129137213763664341966012003786), (38072655187122036146734914410487075640073348974576873024809073004481449022719, 23531348236150388548308638889345990626658593489092173, 3974842273705292093898048321826829396615549694740838509137373741270284432364, 15876987713903608726306436198799064795886298341074493148103610021201002646255), (48767470782838625787583520177248924240082256803304702306223042977231491155486, 47074235706442101184291207657380825765930383743534177, 52910726521873350490916865419065320536039547682210328703137891113473071887809, 100649558230067674074643387939933704581702642456148567943434231789691624358582), (114798627965121058097576415647458832781719634555634374150637548922690575490575, 78530319393663374657875739944763609027937184676916615, 22293404544006669236216076725063843205959790569995451458601824106860982067159, 114508291743243079015990377553028076317355941057601501158005069379417866608215), (32412573017294137694079478546852735332688302592689418871076186822519233765111, 69104302334084034146530702638611718916542509962725066, 86998385843347220330476866946891867268985445116171646554862307413665915412846, 29206696236856988658778987194684672974811073228746828786313032514593423264867), (52068355372290723593948485081006878977578658561770157200531667285638486872819, 11921408538021934390527294454297761032444925039041440, 31918224253604536960653116105371883773400920979739758773315995401147941949894, 84442063001350808919919708934660366819449467932033744685228019769976912621076), (44471138597710390556306248602039628553646166348670561441527555623258325747612, 35532855490379480155480332971167407802391207365167782, 1842464253186197848293654985722097816768857115765528174980115605649897444732, 76651170272632801897014878215869570651968201903620106926177095677751991957334), (41800937603151431106545783788667385380269622182429223477958915402029007270410, 60044763016695803041341683319485363659607969074023494, 28657506049478431455982347329003417315350970200413752378050316720624567099382, 1678214651409158592750230772957920938503128397700897808193195146622962894013), (20349875651673331345158078874572623720808987655574588476214793321357813947920, 86560715554218371460669200605181732847755587450538825, 3426874238659323011599580216989375068055348590866771410428215851910861236917, 10887803508797194462339236715453911560437665390751065823522402150472022471631), (80557373602928669168136080485591415195683157633530119799989865521780155381765, 51500963368876503980880366306714502234297608994918078, 34344901015133896455776901070641099008412654744827203766418462732918198212551, 71705665738150649786484181809336835500750370840376057787043936295907113453135), (72394254195640600587007321952960886781649126243640881790377557306310220574798, 4991887017318500638775427526327552484909539227708113, 88514509677006877470568858829938658663945367436139735184912300410269581410856, 37130171859596470149192501530598153495466238772030547534946299423230364526775), (11208070025829262114084581356335497526399249277440190819850771675803095843117, 22658928363596994793165686757492740279920518437749376, 29082239692163165346976669977664427490805112211440997813728969740226591053233, 3556642711091859976250268363671838143965255313618775661325498870443276907277), (9144966333026936514119860675531229665368494917997886957441135167721265427079, 52055106616838900740226624492276000466652534557512611, 94742504402974188698613243204225684987095417729434168785604912479078811015162, 62580612917100260526493204986184676584317009817257387843515068607428018478736), (54089220163786596007054144304685229650774234809415177287042387726772008744736, 5919587207257445950476732490049053976969782160807183, 36407395602437993133762001522756794871812095932456573485989834604430114460547, 37523771660364561551347891469989753470898578588774177684453287627529341272352), (81585680552534130695325530707291224271126313790398917552805979653350813831945, 74572734513809351240212253379129113337980853028336153, 78543447309935001221318910349044836342575380421880296028207731698023924250908, 30922239270491171302180740962394700299499583793744763026834663648042712806399), (7869543416257095178776700212372944434853014166185270458575646368574094917971, 39014520031545355798685980579847127223677049730844669, 1164934799587031918160615898529614886394041817552652312992504758290910697675, 1811194297520416115378288827959755626541504887853015635326616804327507695684), (68676991913510069238284555554912208252659132132850638715207567267931182911346, 59237506846651291938918356519761733570549817330995009, 82224469928495595935864938725152418188993514844116586245035322391085901611838, 108644199158899354543592208919223014440152070141317562454161563021579114031981), (31423353908715894392729634048470589172208939380081718320498553959827061347690, 39672280472210388811655961686738167363816680041112706, 72269337864539423765124712486138762379912246848346743264667987925675506177407, 6771648365577141375971725529862121451351750765015616269321686476779215992669), (49491124849592789451270549502756684753606960799175239058204937691222154341984, 48758557500661534758328671779023221455484071636851624, 71354567383046814658243983435202701515209478535356322729912768679940795030049, 14416643232242942460484154108321068045062120818619289453777662631756083276365), (95312780624778085405140484825645809584453398598844786853880531442551217361467, 64390798315446272507082974994902309071143947717045599, 104218373633595592309302562645722373442434450061677812941117682736060145573015, 27016140478427536303202949300941273420255783065420381904027912875995088244017), (70686133176827644029586235547267805290795174600287116036432174987791000258152, 53742026455716356127931549466597566261543938895896590, 79985638657603030055649306856311858014280263527570246572717365125584886506553, 32902961699280440052609364650156366700914759463002961213082633917458499645300), (13930099993325222968275560631873255235553382670371659478900866718671055876383, 1886549687750725757666341966780096582281893073210089, 49976411116767875286694210117670328835336254281485589859877006643641339962320, 87842395303362565515947135643754975294094907280249185650549910663874489652694)]

mat = [[0 for i in range(62)] for j in range(62)]

for i in range(30):
    h = arr[i][0]
    lea_k = arr[i][1]
    r = arr[i][2]
    s = arr[i][3]

    mat[i][i] = order
    mat[30][i] = inverse_mod(s, order) * r % order
    mat[31][i] = ((lea_k << 40) - inverse_mod(s, order) * h) % order
    mat[32 + i][i] = 2 ** 216
    mat[32 + i][32 + i] = 1

mat[30][30] = 2**40 / order
mat[31][31] = 2**40

mat = Matrix(mat)
mat = mat.LLL()

for i in range(30):
    h = arr[i][0]
    lea_k = arr[i][1]
    r = arr[i][2]
    s = arr[i][3]

    k = -mat[1][i] + (lea_k << 40) + (mat[1][32 + i] << 216)

    secret = (k * s - h) * inverse_mod(r, order) % order

    sha256 = hashlib.sha256()
    sha256.update(str(secret).encode())
    key = sha256.digest()

    aes = AES.new(key, mode=AES.MODE_ECB)
    flag = bytes.fromhex("bbed80290aa74f601b94260a0eb6c8fcc7022029372201b3d7af01b19a18959d8a22e13e9090e7279dfb942f0782018004f1e58f2c9c328f0e0d1dee3a04603d")
    print(aes.decrypt(flag))
